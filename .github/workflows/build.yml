name: Build Windows x64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
    - name: Build libcurl from source without zlib
      run: |
        # Clone curl repository to libs directory
        Write-Host "Cloning curl repository..."
        git clone --depth 1 --branch curl-8_5_0 https://github.com/curl/curl.git libs\curl
        
        cd libs\curl
        
        # Create build directory
        mkdir build
        cd build
        
        # Configure with CMake - disable zlib and brotli
        Write-Host "Configuring curl..."
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DBUILD_SHARED_LIBS=OFF `
          -DCURL_USE_SCHANNEL=ON `
          -DCURL_ZLIB=OFF `
          -DCURL_BROTLI=OFF `
          -DHTTP_ONLY=OFF `
          -DCURL_DISABLE_LDAP=ON `
          -DCMAKE_USE_LIBSSH2=OFF `
          -DCURL_USE_LIBSSH2=OFF
        
        # Build Release
        Write-Host "Building curl (Release)..."
        cmake --build . --config Release
        
        cd ..\..\..
        Write-Host "Curl build complete"
        
    - name: Build Solution (Debug x64)
      run: |
        msbuild ZapretGUI.sln /t:Build /p:Configuration=Debug /p:Platform=x64 /m /v:minimal /fl "/flp:logfile=build-debug.log;verbosity=diagnostic"
        
    - name: Build Solution (Release x64)
      run: |
        msbuild ZapretGUI.sln /t:Build /p:Configuration=Release /p:Platform=x64 /m /v:minimal /fl "/flp:logfile=build-release.log;verbosity=diagnostic"
        
    - name: List build output files
      run: |
        Write-Host "Looking for MisterFish.exe in the repository..."
        Get-ChildItem -Path . -Filter "MisterFish.exe" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
        Write-Host "`nChecking expected paths:"
        if (Test-Path "ZapretGUI/x64/Release/MisterFish.exe") { Write-Host "Found at: ZapretGUI/x64/Release/MisterFish.exe" }
        if (Test-Path "x64/Release/MisterFish.exe") { Write-Host "Found at: x64/Release/MisterFish.exe" }
        Write-Host "`nListing all .exe files in x64 directories:"
        Get-ChildItem -Path . -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like "*x64*" } | ForEach-Object { Write-Host $_.FullName }
        
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build-debug.log
          build-release.log
        
    - name: Upload Release Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MisterFish-x64
        path: |
          **/x64/Release/MisterFish.exe
          x64/Release/MisterFish.exe
        if-no-files-found: error
