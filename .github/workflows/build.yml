name: Build Windows x64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
    - name: Build libcurl from source without zlib
      run: |
        # Clone curl repository
        Write-Host "Cloning curl repository..."
        git clone --depth 1 --branch curl-8_5_0 https://github.com/curl/curl.git curl-source
        
        cd curl-source
        
        # Create build directory
        mkdir build
        cd build
        
        # Configure with CMake - disable zlib and brotli
        Write-Host "Configuring curl..."
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DBUILD_SHARED_LIBS=OFF `
          -DCURL_USE_SCHANNEL=ON `
          -DCURL_ZLIB=OFF `
          -DCURL_BROTLI=OFF `
          -DHTTP_ONLY=OFF `
          -DCURL_DISABLE_LDAP=ON `
          -DCMAKE_USE_LIBSSH2=OFF `
          -DCURL_USE_LIBSSH2=OFF
        
        # Build Release
        Write-Host "Building curl (Release)..."
        cmake --build . --config Release --target libcurl
        
        cd ..\..
        Write-Host "Curl build complete"
        
    - name: Create curl library directories
      run: |
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Debug\lib"
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Debug\include"
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Release\lib"
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Release\include"
        
    - name: Copy curl files to expected locations
      run: |
        # Copy include files from curl source
        Copy-Item -Recurse -Force "curl-source\include\curl" "libs\curl\x64\Debug\include\"
        Copy-Item -Recurse -Force "curl-source\include\curl" "libs\curl\x64\Release\include\"
        
        # Copy library files
        $libFile = Get-ChildItem "curl-source\build\lib\Release" -Filter "libcurl*.lib" | Select-Object -First 1
        
        if ($libFile) {
          Write-Host "Found curl library: $($libFile.Name) at $($libFile.FullName)"
          
          # Copy for both Debug and Release (using Release build for both)
          Copy-Item -Force $libFile.FullName "libs\curl\x64\Debug\lib\libcurl_a_debug.lib"
          Copy-Item -Force $libFile.FullName "libs\curl\x64\Release\lib\libcurl_a.lib"
        } else {
          Write-Host "ERROR: Could not find curl library file"
          Write-Host "Contents of build/lib/Release:"
          Get-ChildItem "curl-source\build\lib\Release" -ErrorAction SilentlyContinue | Select-Object Name
          Write-Host "Contents of build/lib:"
          Get-ChildItem "curl-source\build\lib" -Recurse -ErrorAction SilentlyContinue | Select-Object Name
          exit 1
        }
        
        # Verify files were copied
        Write-Host "Copied files:"
        Get-ChildItem "libs\curl\x64\Debug\lib" | Select-Object Name
        Get-ChildItem "libs\curl\x64\Release\lib" | Select-Object Name
        
    - name: Build Solution (Debug x64)
      run: |
        msbuild ZapretGUI.sln /t:Build /p:Configuration=Debug /p:Platform=x64 /m /v:minimal /fl /flp:logfile=build-debug.log;verbosity=diagnostic
        
    - name: Build Solution (Release x64)
      run: |
        msbuild ZapretGUI.sln /t:Build /p:Configuration=Release /p:Platform=x64 /m /v:minimal /fl /flp:logfile=build-release.log;verbosity=diagnostic
        
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build-debug.log
          build-release.log
        
    - name: Upload Release Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MisterFish-x64
        path: ZapretGUI/x64/Release/MisterFish.exe
        if-no-files-found: error
