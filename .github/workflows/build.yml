name: Build Windows x64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'c8696863d371ab7f46e213d8f5ca923c4aef2a00'
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.VCPKG_ROOT }}/installed
          ${{ env.VCPKG_ROOT }}/packages
        key: ${{ runner.os }}-vcpkg-c8696863d371ab7f46e213d8f5ca923c4aef2a00-curl-ssl-x64-windows-static
        restore-keys: |
          ${{ runner.os }}-vcpkg-c8696863d371ab7f46e213d8f5ca923c4aef2a00-
        
    - name: Install libcurl via vcpkg
      run: |
        vcpkg install "curl[core,ssl,schannel,sspi,!zlib,!brotli]:x64-windows-static"
        
    - name: Create curl library directories
      run: |
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Debug\lib"
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Debug\include"
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Release\lib"
        New-Item -ItemType Directory -Force -Path "libs\curl\x64\Release\include"
        
    - name: Copy vcpkg curl files to expected locations
      run: |
        # Debug: Show what we have
        Write-Host "VCPKG_ROOT: $env:VCPKG_ROOT"
        Write-Host "Checking vcpkg installed release libraries:"
        Get-ChildItem "$env:VCPKG_ROOT\installed\x64-windows-static\lib" -Filter "libcurl*.lib" | Select-Object Name
        Write-Host "Checking vcpkg installed debug libraries:"
        if (Test-Path "$env:VCPKG_ROOT\installed\x64-windows-static\debug\lib") {
          Get-ChildItem "$env:VCPKG_ROOT\installed\x64-windows-static\debug\lib" -Filter "libcurl*.lib" | Select-Object Name
        } else {
          Write-Host "No debug lib directory found, will use release library for both"
        }
        Write-Host "Include directories:"
        Get-ChildItem "$env:VCPKG_ROOT\installed\x64-windows-static\include" | Select-Object Name
        
        # Copy include files
        Copy-Item -Recurse -Force "$env:VCPKG_ROOT\installed\x64-windows-static\include\curl" "libs\curl\x64\Debug\include\"
        Copy-Item -Recurse -Force "$env:VCPKG_ROOT\installed\x64-windows-static\include\curl" "libs\curl\x64\Release\include\"
        
        # Find and copy debug library
        $debugLib = $null
        if (Test-Path "$env:VCPKG_ROOT\installed\x64-windows-static\debug\lib") {
          $debugLib = Get-ChildItem "$env:VCPKG_ROOT\installed\x64-windows-static\debug\lib" -Filter "libcurl*.lib" | Select-Object -First 1
        }
        if ($debugLib) {
          Write-Host "Found debug curl library: $($debugLib.Name)"
          Copy-Item -Force $debugLib.FullName "libs\curl\x64\Debug\lib\libcurl_a_debug.lib"
        } else {
          Write-Host "No debug library found, using release library for debug configuration"
          $releaseLib = Get-ChildItem "$env:VCPKG_ROOT\installed\x64-windows-static\lib" -Filter "libcurl*.lib" | Select-Object -First 1
          Copy-Item -Force $releaseLib.FullName "libs\curl\x64\Debug\lib\libcurl_a_debug.lib"
        }
        
        # Find and copy release library
        $releaseLib = Get-ChildItem "$env:VCPKG_ROOT\installed\x64-windows-static\lib" -Filter "libcurl*.lib" | Select-Object -First 1
        Write-Host "Found release curl library: $($releaseLib.Name)"
        Copy-Item -Force $releaseLib.FullName "libs\curl\x64\Release\lib\libcurl_a.lib"
        
        # Verify files were copied
        Write-Host "Copied files:"
        Get-ChildItem "libs\curl\x64\Debug\lib" | Select-Object Name
        Get-ChildItem "libs\curl\x64\Release\lib" | Select-Object Name
        
    - name: Build Solution (Debug x64)
      run: |
        msbuild ZapretGUI.sln /t:Build /p:Configuration=Debug /p:Platform=x64 /m /v:minimal /fl /flp:logfile=build-debug.log;verbosity=diagnostic
        
    - name: Build Solution (Release x64)
      run: |
        msbuild ZapretGUI.sln /t:Build /p:Configuration=Release /p:Platform=x64 /m /v:minimal /fl /flp:logfile=build-release.log;verbosity=diagnostic
        
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build-debug.log
          build-release.log
        
    - name: Upload Release Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MisterFish-x64
        path: ZapretGUI/x64/Release/MisterFish.exe
        if-no-files-found: error
